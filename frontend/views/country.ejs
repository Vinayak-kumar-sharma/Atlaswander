<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= name %> â€“ Country Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="/css/country.css">
</head>
<body>

  <!-- Header -->
<header>
    <h1>ğŸ—ºï¸ Atlas Wander</h1>
    <p>Explore the unseen: From climates to creatures to cultures.</p>
    <div class="site-brand">
    <a href="/" class="home-link">Back to Home</a>
    </div>
</header>

  <!-- Hero -->
  <section class="hero">
    <h1><%= name %></h1>
    <img src="<%= flag %>" alt="<%= name %> Flag" class="flag" />
    <div class="facts">
      <p><strong>Capital:</strong> <%= capital %></p>
      <p><strong>Region:</strong> <%= region %> â€“ <%= subregion %></p>
      <p><strong>Population:</strong> <%= population.toLocaleString() %></p>
      <p><strong>Languages:</strong> <%= languages.join(", ") %></p>
      <p><strong>Currencies:</strong> <%= currencies.join(", ") %></p>
      <p><strong>UN Member:</strong> <%= un_member ? "Yes" : "No" %></p>
    </div>
  </section>

  <!-- Map -->
  <section class="map-section">
    <h2>ğŸ—º Interactive Map</h2>
    <div id="dynamicMap"></div>
  </section>

  <!-- Map Links -->
  <section class="map-links">
    <h3>ğŸ”— Explore on External Maps</h3>
    <ul id="mapLinks">
      <li><a href="https://www.google.com/maps/search/<%= name %>" target="_blank">Google Maps</a></li>
      <li><a href="https://www.openstreetmap.org/search?query=<%= name %>" target="_blank">OpenStreetMap</a></li>
      <li><a href="https://earth.google.com/web/search/<%= name %>" target="_blank">Google Earth</a></li>
    </ul>
  </section>

  <!-- Info Cards -->
<section class="climate-section">
  <h2>ğŸŒ¤ Climate Overview</h2>
  <div class="climate-summary" id="climateSummary">
    <!-- JS will fill this -->
  </div>
  <div class="climate-table-container" id="climateInfo">
    Loading climate data...
  </div>
</section>

<!-- Population Section -->
<section class="population-section">
  <h2>ğŸ‘¥ Population Snapshot</h2>
  <div class="population-stats">
    <div class="stat-card">
      <h3>Total Population</h3>
      <p><%= population.toLocaleString() %></p>
    </div>
    <!-- Future additions: growth, density, etc. -->
  </div>
</section>

<!-- States Section -->
<section class="states-section">
  <h2>ğŸ› States </h2>
  <p id="totalStates">Loading states...</p>
  <div class="states-grid" id="statesGrid">
    <!-- JavaScript will populate this -->
  </div>
</section>


<!-- Wildlife Section -->
<section class="wildlife-section">
  <h2>ğŸ¦ Wildlife</h2>
  <div class="wildlife-grid" id="wildlifeInfo">
    Loading wildlife data...
  </div>
</section>


  <!-- Footer -->
  <%- include('partials/footer') %>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const lat = <%= coordinates.lat %>;
  const lon = <%= coordinates.lon %>;
  const countryName = "<%= name %>";
  const countryCode = "<%= countryCode %>";

  const map = L.map('dynamicMap').setView([lat, lon], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  L.marker([lat, lon]).addTo(map)
    .bindPopup(`ğŸ“ ${countryName}`)
    .openPopup();

  async function fetchExtraInfo() {
    try {
      // --- Climate Data ---
      const climateRes = await fetch(`/api/climate?country=${encodeURIComponent(countryName)}`);
      const climateData = await climateRes.json();
      const climate = climateData.climate;
      const climateInfo = document.getElementById("climateInfo");
      const climateSummary = document.getElementById("climateSummary");

      if (climate?.time?.length) {
        const avgMax = (climate.temperature_2m_max.reduce((a, b) => a + b, 0) / climate.temperature_2m_max.length).toFixed(1);
        const avgMin = (climate.temperature_2m_min.reduce((a, b) => a + b, 0) / climate.temperature_2m_min.length).toFixed(1);

        climateSummary.innerHTML = `
          <div><h4>Avg Max</h4><p>${avgMax} Â°C</p></div>
          <div><h4>Avg Min</h4><p>${avgMin} Â°C</p></div>
          <div><h4>Data Points</h4><p>${climate.time.length}</p></div>
        `;

        let table = `<table class="climate-table"><thead><tr><th>Date</th><th>Max (Â°C)</th><th>Min (Â°C)</th></tr></thead><tbody>`;
        for (let i = 0; i < climate.time.length; i++) {
          table += `<tr><td>${climate.time[i]}</td><td>${climate.temperature_2m_max[i]}</td><td>${climate.temperature_2m_min[i]}</td></tr>`;
        }
        table += "</tbody></table>";
        climateInfo.innerHTML = table;
      } else {
        climateInfo.textContent = "No climate data available.";
      }

      // --- Wildlife Data ---
      const wildlifeRes = await fetch(`/api/wildlife?countryCode=${encodeURIComponent(countryCode)}`);
      const wildlife = await wildlifeRes.json();
      const wildlifeContainer = document.getElementById("wildlifeInfo");
      wildlifeContainer.innerHTML = "";

      const species = wildlife.species || [];
      if (!species.length) {
        wildlifeContainer.textContent = "No wildlife data available.";
      } else {
        species.slice(0, 12).forEach(item => {
          const card = document.createElement("div");
          card.className = "wildlife-card";

          const fullImage = item.image_url || '/images/placeholder.jpg';

          card.innerHTML = `
            <a href="#" class="wildlife-image-link">
              <img src="${fullImage}" alt="${item.species}" data-full="${fullImage}" />
            </a>
            <div class="wildlife-details">
              <h4>${item.species}</h4>
              <p><strong>Scientific Name:</strong> ${item.scientific_name || 'N/A'}</p>
              <p><strong>Class:</strong> ${item.class || 'N/A'}</p>
              <p><strong>Order:</strong> ${item.order || 'N/A'}</p>
              <p><strong>Family:</strong> ${item.family || 'N/A'}</p>
              <p><strong>Kingdom:</strong> ${item.kingdom || 'N/A'}</p>
              <p><strong>Region:</strong> ${item.state_province || 'N/A'}</p>
              <p><strong>Observed:</strong> ${item.date_observed || 'N/A'}</p>
              <p><strong>Observer:</strong> ${item.recorded_by || 'Unknown'}</p>
              <p><strong>Institution:</strong> ${item.institution || 'N/A'}</p>
            </div>
          `;
          wildlifeContainer.appendChild(card);
        });
        setupImageModal();
      }

      // --- States Data ---
const statesRes = await fetch(`/api/states/${countryCode}`);
  if (!statesRes.ok) throw new Error("Failed to fetch states");

  const statesData = await statesRes.json();
  const states = statesData.states || [];

  const statesGrid = document.getElementById("statesGrid");
  const statesCount = document.getElementById("totalStates");

  if (!states.length) {
    statesCount.textContent = "No states or territories found.";
    return;
  }

  // Sort alphabetically
  states.sort((a, b) => a.name.localeCompare(b.name));

  // Update total count
  statesCount.textContent = `Total States: ${states.length}`;

  // Generate cards
  states.forEach(state => {
    const card = document.createElement("div");
    card.className = "state-card";
    card.title = `Lat: ${state.lat}, Lon: ${state.lon}`;

    card.innerHTML = `
      <a href="/api/cities/${countryCode}/${state.isoCode}" class="state-link">
        ${state.name}
      </a>
    `;

    statesGrid.appendChild(card);
  });


    } catch (err) {
      console.error(err);
      document.getElementById("climateInfo").textContent = "Error loading climate.";
      document.getElementById("wildlifeInfo").textContent = "Error loading wildlife.";
      const statesCount = document.getElementById("totalStates");
      if (statesCount) statesCount.textContent = "Error loading states.";
    }
  }

// 
  
function setupImageModal() {
    document.querySelectorAll(".wildlife-image-link img").forEach(img => {
      img.addEventListener("click", function (e) {
        e.preventDefault();
        const modal = document.getElementById("imageModal");
        const modalImg = document.getElementById("modalImg");
        modal.style.display = "block";
        modalImg.src = this.dataset.full;
      });
    });

    document.querySelector(".image-modal .close").addEventListener("click", () => {
      document.getElementById("imageModal").style.display = "none";
    });
  }

  fetchExtraInfo();
</script>

  
  <div id="imageModal" class="image-modal">
  <span class="close">&times;</span>
  <img class="modal-content" id="modalImg" />
</div>
</body>
</html>
